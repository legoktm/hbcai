Code is very messy, but works. Maybe.
